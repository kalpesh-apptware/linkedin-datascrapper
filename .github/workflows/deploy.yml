name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_USERNAME }}/linkedin-ocr-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_USERNAME }}/linkedin-ocr-frontend

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build Backend
      run: docker build -f backend/Dockerfile -t test-backend .
      
    - name: Build Frontend
      run: docker build -f project/Dockerfile -t test-frontend .

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build and Push Backend
      uses: docker/build-push-action@v4
      with:
        context: .
        file: backend/Dockerfile
        push: true
        tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
        
    - name: Build and Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./project
        file: project/Dockerfile
        push: true
        tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest

    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Pull latest images
          docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          
          # Clone/Update repo to get docker-compose.yml (optional if we transfer it, assuming repo exists or we just maintain compose file)
          # Alternatively, we can just run docker-compose if the file is there.
          # Let's assume the user will copy the docker-compose.yml to the server once.
          
          # OR better: copy docker-compose.yml via scp or just use the images directly if orchestrated manually?
          # Best practice: checkout repo on server or copy file.
          
          # Simple approach: Re-create docker-compose.yml or assume it exists.
          # We'll try to update it or assume git pull if repo is cloned.
          if [ -d "linkedin_ocr" ]; then
            cd linkedin_ocr
            git pull
          else
            git clone https://github.com/${{ github.repository }}.git linkedin_ocr
            cd linkedin_ocr
          fi
          
          # Stop old containers
          docker compose down
          
          # Start new containers
          docker compose up -d
